# Story 1.3: User Sign-Up and Wallet Creation

## Status
**Current Status:** In Progress
**Assigned To:** Dev Agent
**Sprint:** Epic 1 - Foundation & User Onboarding
**Story Points:** 8
**Priority:** High

## Story
**As a** new user,
**I want** to easily sign up for a STACK account and have a secure wallet automatically created for me,
**so that** I can start my investment journey without understanding complex crypto concepts.

### Background
Following the completion of the project scaffolding (Story 1.1), smart contract deployment (Story 1.2), and database schema initialization (Story 1.2a), we now need to implement the user authentication and wallet creation system. This story establishes the foundation for user onboarding by providing a seamless sign-up experience that automatically creates both a user account and a secure in-app wallet using Thirdweb's authentication and wallet management capabilities.

### Business Value
- Enables user onboarding and account creation
- Provides secure wallet management without exposing users to crypto complexity
- Establishes the authentication foundation for all subsequent features
- Creates the user data foundation needed for portfolio tracking and gamification

## Acceptance Criteria

### AC1: User Sign-Up Implementation
- [ ] A user can sign up for an account using a simple method (e.g., social login or email/password)
- [ ] User registration creates a new User record in the database with all required fields
- [ ] Input validation ensures email uniqueness and proper data formatting
- [ ] Error handling provides clear feedback for registration failures

### AC2: Automatic Wallet Creation
- [ ] Upon sign-up, a new, secure in-app wallet is generated and associated with their user account using the Thirdweb SDK
- [ ] The wallet address is stored in the User model's walletAddress field
- [ ] Wallet creation is atomic with user creation (both succeed or both fail)
- [ ] Wallet private keys are managed securely by Thirdweb (never exposed to our backend)

### AC3: User Authentication & Session Management
- [ ] The user is successfully authenticated, and a session token is returned to the client
- [ ] Session tokens are secure and have appropriate expiration times
- [ ] Authentication state is properly managed on both frontend and backend
- [ ] Users can log out and invalidate their session

### AC4: Secure Data Handling
- [ ] The user's new wallet address is securely stored and is not exposed to the client unless necessary
- [ ] All sensitive user data follows security best practices
- [ ] API endpoints have proper input validation using Zod schemas
- [ ] Error responses don't expose sensitive information

## Tasks/Subtasks

### Task 1: Implement Backend Authentication Service (AC: 1, 3, 4)
**Owner:** Dev Agent
**Estimated Time:** 3 hours
**Dependencies:** Database schema from Story 1.2a

**Subtasks:**
1. Create `thirdwebClient.ts` configuration file following the implementation guide
2. Set up Thirdweb Auth with Express.js following the exact pattern provided in the implementation guide
3. Implement authentication endpoints (`/login` GET/POST, `/isLoggedIn`, `/logout`) as specified
4. Create authentication service in `apps/backend-api/src/services/authService.ts` that integrates with Thirdweb Auth
5. Implement user registration endpoint with Zod validation that combines wallet verification with database operations
6. Add comprehensive error handling, input validation, and security middleware

### Task 2: Implement Thirdweb Wallet Integration (AC: 2, 4)
**Owner:** Dev Agent
**Estimated Time:** 2.5 hours
**Dependencies:** Task 1 completion, Thirdweb SDK setup

**Subtasks:**
1. Configure Thirdweb SDK for in-app wallet creation
2. Create wallet service in `apps/backend-api/src/services/walletService.ts`
3. Implement automatic wallet generation during user registration
4. Ensure atomic user and wallet creation (transaction handling)
5. Add wallet address validation and storage
6. Implement secure wallet management practices

### Task 3: Create Frontend Authentication Components (AC: 1, 3)
**Owner:** Dev Agent
**Estimated Time:** 2 hours
**Dependencies:** Task 1 completion

**Subtasks:**
1. Create sign-up screen in `apps/mobile-app/app/(auth)/SignUpScreen.tsx`
2. Create login screen in `apps/mobile-app/app/(auth)/LoginScreen.tsx`
3. Implement authentication forms with proper validation
4. Create authentication store using Zustand for state management
5. Add loading states and error handling for auth flows
6. Implement navigation between auth screens

### Task 4: Implement Authentication State Management (AC: 3, 4)
**Owner:** Dev Agent
**Estimated Time:** 1.5 hours
**Dependencies:** Task 3 completion

**Subtasks:**
1. Create auth store in `apps/mobile-app/stores/authStore.ts`
2. Implement persistent session storage
3. Add authentication guards for protected screens
4. Create authentication context and hooks
5. Implement automatic session refresh logic
6. Add logout functionality with proper cleanup

### Task 5: Create Comprehensive Authentication Tests (Testing Requirements)
**Owner:** Dev Agent
**Estimated Time:** 2 hours
**Dependencies:** All previous tasks completion

**Subtasks:**
1. Write unit tests for authentication service and wallet service
2. Write integration tests for auth API endpoints
3. Write component tests for auth screens using React Native Testing Library
4. Write E2E tests for complete sign-up and login flows
5. Test error scenarios and edge cases
6. Verify security measures and data protection

## Dev Notes

### Previous Story Insights
From Story 1.2a: The complete database schema is now available with the User model properly configured including the walletAddress field. The Prisma client is set up and ready for user data operations. All database relationships are established for future features.

### Technology Stack Requirements
[Source: architecture/tech-stack.md]
**Authentication & Blockchain:**
- Thirdweb Auth (Latest) for user authentication and wallet management
- Thirdweb SDK (Latest) for all blockchain interactions and in-app wallet creation
- TypeScript 5.4+ as primary language for consistency across monorepo

**Backend Framework:**
- Express.js 4.18+ for API framework in serverless functions
- Prisma 5.10+ for type-safe database operations
- Zod for input validation on all API routes

**Frontend Framework:**
- Expo (React Native) SDK 51+ for mobile app development
- Zustand 4.5+ for global state management
- NativeWind 4.0+ for styling

### Data Models Integration
[Source: architecture/data-models.md]
**User Model Structure:**
```prisma
model User {
  id              String    @id @default(cuid())
  email           String?   @unique
  walletAddress   String    @unique
  displayName     String
  avatarUrl       String?
  bio             String?
  isCurator       Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  // Related models will be populated in future stories
  portfolio       Portfolio?
  virtualCard     VirtualCard?
  // ... other relationships
}
```

**Key Requirements:**
- walletAddress must be unique and populated during registration
- email is optional but must be unique if provided
- displayName is required for user identification
- All timestamps are automatically managed by Prisma

### Project Structure Requirements
[Source: architecture/unified-project-structure.md]
**File Locations:**
- Backend services: `apps/backend-api/src/services/`
- API routes: `apps/backend-api/src/routes/`
- Frontend screens: `apps/mobile-app/app/(auth)/`
- Stores: `apps/mobile-app/stores/`
- Shared types: `packages/shared-types/src/`

**Component Structure:**
- Follow atomic design principles for auth components
- Use NativeWind classes exclusively for styling
- Implement proper accessibility features

### Coding Standards
[Source: architecture/coding-standards.md]
**Critical Security Rules:**
- NEVER commit secret keys or environment variables to repository
- All API routes must have input validation using Zod schemas
- Authentication must use Thirdweb Auth for wallet-based login
- All database queries must use Prisma ORM to prevent SQL injection
- Implement proper error handling that doesn't expose sensitive information

**Frontend Standards:**
- Use Zustand for global authentication state
- Implement WCAG 2.1 Level AA compliance for accessibility
- Provide immediate feedback for all user actions within 100ms
- Use engaging, Gen Z-friendly terminology

**Backend Standards:**
- Use consistent error response format
- Implement proper input validation with Zod
- Use Prisma transactions for multi-table operations
- Follow serverless function structure patterns

### External API Integration
[Source: architecture/external-apis.md]
**Thirdweb SDK & APIs:**
- Use Thirdweb SDK for all blockchain interactions and wallet management
- Implement Thirdweb Auth for user authentication and session management
- Ensure wallet creation is compatible with Thirdweb's infrastructure
- Follow Thirdweb best practices for in-app wallet security

### Thirdweb Auth Implementation Guide
**MANDATORY: Follow this exact implementation pattern for Thirdweb Auth in the backend-api**

**Step 1: Create Thirdweb Client Configuration**
Create `apps/backend-api/thirdwebClient.ts`:
```typescript
import { createThirdwebClient } from "thirdweb";

const secretKey = process.env.THIRDWEB_SECRET_KEY!;

export const thirdwebClient = createThirdwebClient({ secretKey });
```

**Step 2: Implement Authentication Server Structure**
Use this pattern for authentication implementation in your Express.js routes:

```typescript
import express from "express";
import cors from "cors";
import cookieParser from "cookie-parser";
import { createAuth, type VerifyLoginPayloadParams } from "thirdweb/auth";
import { privateKeyToAccount } from "thirdweb/wallets";
import { thirdwebClient } from "./thirdwebClient";

const app = express();
app.use(express.json());
app.use(cookieParser());
app.use(
  cors({
    origin: `${
      process.env.NODE_ENV === "development" ? "http" : "https"
    }://${process.env.CLIENT_DOMAIN}`,
    credentials: true,
  })
);

const thirdwebAuth = createAuth({
  domain: process.env.CLIENT_DOMAIN!,
  client: thirdwebClient,
  adminAccount: privateKeyToAccount({
    client: thirdwebClient,
    privateKey: process.env.ADMIN_PRIVATE_KEY!,
  }),
});

// Health check endpoint
app.get("/", (req, res) => {
  return res.send("Auth server is live");
});

// Generate login payload
app.get("/login", async (req, res) => {
  const address = req.query.address;
  const chainId = req.query.chainId as string | undefined;

  if (typeof address !== "string") {
    return res.status(400).send("Address is required");
  }

  return res.send(
    await thirdwebAuth.generatePayload({
      address,
      chainId: chainId ? parseInt(chainId) : undefined,
    })
  );
});

// Verify login and generate JWT
app.post("/login", async (req, res) => {
  const payload: VerifyLoginPayloadParams = req.body;

  const verifiedPayload = await thirdwebAuth.verifyPayload(payload);

  if (verifiedPayload.valid) {
    const jwt = await thirdwebAuth.generateJWT({
      payload: verifiedPayload.payload,
    });
    res.cookie("jwt", jwt);
    return res.status(200).send({ token: jwt });
  }

  res.status(400).send("Failed to login");
});

// Check authentication status
app.get("/isLoggedIn", async (req, res) => {
  const jwt = req.cookies?.jwt;

  if (!jwt) {
    return res.send(false);
  }

  const authResult = await thirdwebAuth.verifyJWT({ jwt });

  if (!authResult.valid) {
    return res.send(false);
  }

  return res.send(true);
});

// Logout endpoint
app.post("/logout", (req, res) => {
  res.clearCookie("jwt");
  return res.send(true);
});

app.listen(3000, () => {
  console.log(`âš¡ Auth server listening on port 3000...`);
});
```

**Step 3: React Native Frontend Configuration**
**MANDATORY: Configure Thirdweb for React Native mobile app**

First, create the Thirdweb client configuration for React Native in `apps/mobile-app/lib/client.ts`:
```typescript
import { createThirdwebClient } from "thirdweb";

const clientId = process.env.EXPO_PUBLIC_THIRDWEB_CLIENT_ID!;

export const client = createThirdwebClient({ clientId });
```

Create API utility functions in `apps/mobile-app/lib/api.ts`:
```typescript
interface ApiParams {
  url: string;
  params?: any;
}

export async function get({ url, params }: ApiParams) {
  const urlWithParams = new URL(url);
  if (params) {
    Object.keys(params).forEach(key => 
      urlWithParams.searchParams.append(key, params[key])
    );
  }
  
  const response = await fetch(urlWithParams.toString(), {
    method: 'GET',
    credentials: 'include',
  });
  
  return response.json();
}

export async function post({ url, params }: ApiParams) {
  const response = await fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    credentials: 'include',
    body: JSON.stringify(params),
  });
  
  return response.json();
}
```

Implement the ConnectButton component in `apps/mobile-app/components/ConnectButtonAuth.tsx`:
```typescript
import { ConnectButton } from "thirdweb/react";
import { client } from "../lib/client";
import { LoginPayload, VerifyLoginPayloadParams } from "thirdweb/auth";
import { get, post } from "../lib/api";
import { sepolia } from "thirdweb/chains";

export default function ConnectButtonAuth() {
  return (
    <ConnectButton
      theme="dark"
      client={client}
      /**
       * Looking to authenticate with account abstraction enabled? Uncomment the following lines:
       * 
       * accountAbstraction={{
       *  chain: sepolia,
       *  factoryAddress: "0x5cA3b8E5B82D826aF6E8e9BA9E4E8f95cbC177F4",
       *  gasless: true,
       * }}
       */
      auth={{
        /**
         * `getLoginPayload` should @return {VerifyLoginPayloadParams} object.
         * This can be generated on the server with the generatePayload method.
         */
        getLoginPayload: async (params: {
          address: string;
        }): Promise<LoginPayload> => {
          return get({
            url: process.env.EXPO_PUBLIC_AUTH_API + "/login",
            params: {
              address: params.address,
              chainId: sepolia.id.toString(),
            },
          });
        },
        /**
         * `doLogin` performs any logic necessary to log the user in using the signed payload.
         * In this case, this means sending the payload to the server for it to set a JWT cookie for the user.
         */
        doLogin: async (params: VerifyLoginPayloadParams) => {
          await post({
            url: process.env.EXPO_PUBLIC_AUTH_API + "/login",
            params,
          });
        },
        /**
         * `isLoggedIn` returns true or false to signal if the user is logged in.
         * Here, this is done by calling the server to check if the user has a valid JWT cookie set.
         */
        isLoggedIn: async () => {
          return await get({
            url: process.env.EXPO_PUBLIC_AUTH_API + "/isLoggedIn",
          });
        },
        /**
         * `doLogout` performs any logic necessary to log the user out.
         * In this case, this means sending a request to the server to clear the JWT cookie.
         */
        doLogout: async () => {
          await post({
            url: process.env.EXPO_PUBLIC_AUTH_API + "/logout",
          });
        },
      }}
    />
  );
}
```

**Required Environment Variables:**
Add these to your `.env` file in `apps/backend-api/`:
```
THIRDWEB_SECRET_KEY=your_thirdweb_secret_key
CLIENT_DOMAIN=localhost:3000
ADMIN_PRIVATE_KEY=your_admin_private_key
NODE_ENV=development
```

Add these to your `.env` file in `apps/mobile-app/`:
```
EXPO_PUBLIC_THIRDWEB_CLIENT_ID=your_thirdweb_client_id
EXPO_PUBLIC_AUTH_API=http://localhost:3000
```

**React Native Configuration Requirements:**
- Install required Thirdweb packages: `npm install thirdweb @thirdweb-dev/react-native`
- Configure Thirdweb provider in your app root component
- Ensure proper environment variable setup for Expo
- Configure network settings for development (localhost API access)
- Set up proper TypeScript types for Thirdweb components

**Integration Requirements:**
- Integrate this authentication pattern with your existing Prisma database operations
- Combine wallet address verification with user registration/login flows
- Ensure JWT tokens are used for protecting API routes
- Implement proper error handling and validation using Zod schemas
- Add rate limiting and security middleware as per coding standards

### Technical Constraints
**Authentication Requirements:**
- Must use Thirdweb Auth for Web3-native authentication
- Session tokens must be secure with appropriate expiration
- Wallet private keys must never be exposed to backend or frontend
- Must support both email/password and social login options

**Security Considerations:**
- Implement proper input validation on all endpoints
- Use HTTPS for all authentication communications
- Store sensitive data securely using environment variables
- Implement rate limiting for authentication endpoints
- Follow OWASP security guidelines for authentication

**Performance Requirements:**
- Authentication flows must be optimized for mobile devices
- Wallet creation should complete within 5 seconds
- Session management must be efficient and not impact app performance
- Database operations must use proper indexing (walletAddress, email)

## Testing
[Source: architecture/testing-strategy.md]

**Test File Locations:**
- Backend unit tests: Co-located with service files (`*.test.ts`)
- Backend integration tests: `apps/backend-api/__tests__/`
- Frontend component tests: Co-located with components (`*.test.tsx`)
- E2E tests: `apps/mobile-app/e2e/`

**Testing Requirements for This Story:**
- Unit tests for authentication and wallet services
- Integration tests for auth API endpoints with live database
- Component tests for auth screens using React Native Testing Library
- E2E tests for complete sign-up and login user flows
- Security testing for authentication vulnerabilities
- Error scenario testing for network failures and invalid inputs

**Testing Frameworks:**
- Jest & Supertest for backend API testing
- Jest & React Native Testing Library for frontend component testing
- Playwright for end-to-end testing
- Test database setup for integration tests

**Specific Test Cases:**
- User registration with valid and invalid data
- Wallet creation success and failure scenarios
- Authentication state persistence across app restarts
- Session token validation and expiration
- Error handling for network failures
- Accessibility testing for auth screens

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-20 | 1.0 | Initial story creation | Scrum Master |
| 2025-01-20 | 1.1 | Added detailed Thirdweb Auth implementation guide with code examples and configuration | Dev Agent |

## Dev Agent Record
### Agent Model Used
Claude 3.5 Sonnet (Trae AI) - Started: 2025-01-20

### Debug Log References
*To be populated during development*

### Completion Notes List
*To be populated during development*

### File List
*To be populated during development*

## QA Results
*To be populated by QA Agent*
